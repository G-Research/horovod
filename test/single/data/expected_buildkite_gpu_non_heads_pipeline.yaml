steps:
- label: ':docker: Build test-gpu-openmpi-gloo-py3_8-tf2_11_0-keras2_11_0-torch1_13_0-mxnet1_9_1-pyspark3_3_1'
  env:
    COMPOSE_HTTP_TIMEOUT: 300
  plugins:
  - docker-compose#v3.10.0:
      build: test-gpu-openmpi-gloo-py3_8-tf2_11_0-keras2_11_0-torch1_13_0-mxnet1_9_1-pyspark3_3_1
      image-repository: 823773083436.dkr.ecr.us-east-1.amazonaws.com/buildkite
      config: docker-compose.test.yml
      push-retries: 5
  - ecr#v1.2.0:
      login: true
  timeout_in_minutes: 40
  retry:
    automatic: true
  agents:
    queue: cpu-v5111
- label: ':docker: Build test-gpu-openmpi-gloo-py3_7-tfmin-kerasmin-torchmin-mxnetmin-pysparkmin'
  env:
    COMPOSE_HTTP_TIMEOUT: 300
  plugins:
  - docker-compose#v3.10.0:
      build: test-gpu-openmpi-gloo-py3_7-tfmin-kerasmin-torchmin-mxnetmin-pysparkmin
      image-repository: 823773083436.dkr.ecr.us-east-1.amazonaws.com/buildkite
      config: docker-compose.test.yml
      push-retries: 5
  - ecr#v1.2.0:
      login: true
  timeout_in_minutes: 40
  retry:
    automatic: true
  agents:
    queue: cpu-v5111
- label: ':docker: Build test-mixed-openmpi-gloo-py3_8-tf2_11_0-keras2_11_0-torch1_13_0-mxnet1_9_1-pyspark3_3_1'
  env:
    COMPOSE_HTTP_TIMEOUT: 300
  plugins:
  - docker-compose#v3.10.0:
      build: test-mixed-openmpi-gloo-py3_8-tf2_11_0-keras2_11_0-torch1_13_0-mxnet1_9_1-pyspark3_3_1
      image-repository: 823773083436.dkr.ecr.us-east-1.amazonaws.com/buildkite
      config: docker-compose.test.yml
      push-retries: 5
  - ecr#v1.2.0:
      login: true
  timeout_in_minutes: 40
  retry:
    automatic: true
  agents:
    queue: cpu-v5111
- wait
- wait
- label: ':pytest: Gloo Cluster PyTests (test-gpu-openmpi-gloo-py3_8-tf2_11_0-keras2_11_0-torch1_13_0-mxnet1_9_1-pyspark3_3_1)'
  command: bash -c "HOROVOD_TEST_GPU=1 /etc/init.d/ssh start && cd /horovod/test/integration && pytest --forked -v --capture=fd --continue-on-collection-errors --junit-xml=/artifacts/junit.gloo.static.xml test_static_run.py"
  artifact_paths: "artifacts/**"
  env:
    COMPOSE_HTTP_TIMEOUT: 300
  plugins:
  - docker-compose#v3.10.0:
      run: test-gpu-openmpi-gloo-py3_8-tf2_11_0-keras2_11_0-torch1_13_0-mxnet1_9_1-pyspark3_3_1
      volumes: "./artifacts:/artifacts"
      config: docker-compose.test.yml
      pull-retries: 3
  - ecr#v1.2.0:
      login: true
  timeout_in_minutes: 10
  retry:
    automatic: true
  agents:
    queue: 4x-gpu-v5111
- label: ':pytest: MPI Cluster PyTests (test-gpu-openmpi-gloo-py3_8-tf2_11_0-keras2_11_0-torch1_13_0-mxnet1_9_1-pyspark3_3_1)'
  command: bash -c " HOROVOD_TEST_GPU=1 /etc/init.d/ssh start && cd /horovod/test/integration && pytest --forked -v --capture=fd --continue-on-collection-errors --junit-xml=/artifacts/junit.mpi.static.xml test_static_run.py"
  artifact_paths: "artifacts/**"
  env:
    COMPOSE_HTTP_TIMEOUT: 300
  plugins:
  - docker-compose#v3.10.0:
      run: test-gpu-openmpi-gloo-py3_8-tf2_11_0-keras2_11_0-torch1_13_0-mxnet1_9_1-pyspark3_3_1
      volumes: "./artifacts:/artifacts"
      config: docker-compose.test.yml
      pull-retries: 3
  - ecr#v1.2.0:
      login: true
  timeout_in_minutes: 10
  retry:
    automatic: true
  agents:
    queue: 4x-gpu-v5111
- label: ':pytest: Gloo Cluster PyTests (test-mixed-openmpi-gloo-py3_8-tf2_11_0-keras2_11_0-torch1_13_0-mxnet1_9_1-pyspark3_3_1)'
  command: bash -c "HOROVOD_TEST_GPU=1 /etc/init.d/ssh start && cd /horovod/test/integration && pytest --forked -v --capture=fd --continue-on-collection-errors --junit-xml=/artifacts/junit.gloo.static.xml test_static_run.py"
  artifact_paths: "artifacts/**"
  env:
    COMPOSE_HTTP_TIMEOUT: 300
  plugins:
  - docker-compose#v3.10.0:
      run: test-mixed-openmpi-gloo-py3_8-tf2_11_0-keras2_11_0-torch1_13_0-mxnet1_9_1-pyspark3_3_1
      volumes: "./artifacts:/artifacts"
      config: docker-compose.test.yml
      pull-retries: 3
  - ecr#v1.2.0:
      login: true
  timeout_in_minutes: 10
  retry:
    automatic: true
  agents:
    queue: 4x-gpu-v5111
- label: ':pytest: MPI Cluster PyTests (test-mixed-openmpi-gloo-py3_8-tf2_11_0-keras2_11_0-torch1_13_0-mxnet1_9_1-pyspark3_3_1)'
  command: bash -c " HOROVOD_TEST_GPU=1 /etc/init.d/ssh start && cd /horovod/test/integration && pytest --forked -v --capture=fd --continue-on-collection-errors --junit-xml=/artifacts/junit.mpi.static.xml test_static_run.py"
  artifact_paths: "artifacts/**"
  env:
    COMPOSE_HTTP_TIMEOUT: 300
  plugins:
  - docker-compose#v3.10.0:
      run: test-mixed-openmpi-gloo-py3_8-tf2_11_0-keras2_11_0-torch1_13_0-mxnet1_9_1-pyspark3_3_1
      volumes: "./artifacts:/artifacts"
      config: docker-compose.test.yml
      pull-retries: 3
  - ecr#v1.2.0:
      login: true
  timeout_in_minutes: 10
  retry:
    automatic: true
  agents:
    queue: 4x-gpu-v5111
- wait
